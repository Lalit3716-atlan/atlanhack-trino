schemaType: Bundle
schemaVersion: 1.0.1
name: applications/phoenix-postgres-app-main/edge
description: "A CNAB bundle to manage the Postgres App"
registry: "harbor-phoenix.atlan.dev"
dockerfile: Dockerfile.tmpl

mixins:
  - exec

parameters:
  - name: platform
    type: string
    default: "edge"
    description: "The platform environment variable to pass at runtime"
  - name: otel_endpoint
    type: string
    default: "http://localhost:8000/telemetry"
    description: "The OpenTelemetry OTLP endpoint"
  - name: otel_protocol
    type: string
    default: "http/protobuf"
    description: "The OpenTelemetry OTLP protocol"
  - name: otel_logging_enabled
    type: string
    default: "true"
    description: "The OpenTelemetry Python logging auto-instrumentation flag"
  - name: otel_excluded_urls
    type: string
    default: "/telemetry/.*,/system/.*"
    description: "The OpenTelemetry Python excluded URLs"

install:
  - exec:
      description: "Install the Postgres App"
      command: /bin/bash
      arguments:
        - '-c'
        - 'export PLATFORM={{bundle.parameters.platform}} &&
          export OTEL_EXPORTER_OTLP_ENDPOINT={{bundle.parameters.otel_endpoint}} &&
          export OTEL_EXPORTER_OTLP_PROTOCOL={{bundle.parameters.otel_protocol}} &&
          export OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED={{bundle.parameters.otel_logging_enabled}} &&
          export OTEL_PYTHON_EXCLUDED_URLS={{bundle.parameters.otel_excluded_urls}} &&
          poetry run ./.venv/bin/opentelemetry-instrument --traces_exporter otlp --metrics_exporter otlp --logs_exporter otlp --service_name postgresql-application python main.py'

upgrade:
  - exec:
      description: "Upgrade the Postgres App"
      command: /bin/bash
      arguments:
        - '-c'
        - 'echo "No upgrade required"'

uninstall:
  - exec:
      description: "Uninstall the Postgres App"
      command: /bin/bash
      arguments:
        - '-c'
        - 'echo "Goodbye!"'
